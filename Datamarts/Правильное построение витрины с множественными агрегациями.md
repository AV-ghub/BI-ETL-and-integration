# –ü–æ–¥—Ö–æ–¥ —Å –∫–∞—Å–∫–∞–¥–æ–º CTE –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞ –ë –≤ –º–∞—Å—Å–∏–≤—ã ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è ClickHouse

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥

1.  **–ò–∑–±–µ–≥–∞–Ω–∏–µ —É–º–Ω–æ–∂–µ–Ω–∏—è —Å—Ç—Ä–æ–∫** —á–µ—Ä–µ–∑ `GROUP BY` –∫–ª—é—á–∞ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—é –≤ `Array` ‚Äî —ç—Ç–æ **–∏–¥–∏–æ–º–∞—Ç–∏—á–Ω—ã–π –¥–ª—è ClickHouse —Å–ø–æ—Å–æ–±**.
2.  **–ö–∞—Å–∫–∞–¥ CTE** ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ. ClickHouse –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ CTE, –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ `JOIN` –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —É–∂–µ –ø–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–º –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º. –≠—Ç–æ –Ω–∞–º–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ, —á–µ–º `JOIN` –ø–æ —Å—ã—Ä—ã–º —Ç–∞–±–ª–∏—Ü–∞–º.
3.  **–û—Ç–∫–∞–∑ –æ—Ç `INNER JOIN` —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö** ‚Äî –≤—ã –ø—Ä–∞–≤—ã, —ç—Ç–æ —Å–ª–∞–±–æ–µ –º–µ—Å—Ç–æ ClickHouse, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö.

–í–∞—à–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∏—Ç—Ä–∏–Ω—ã –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:
```sql
WITH
    type_a_data AS (
        SELECT
            key,
            attr1,
            attr2
        FROM table_a
        GROUP BY key, attr1, attr2
    ),
    type_b_data_agg_1 AS (
        SELECT
            key,
            groupArray(value_1) AS aggregated_values_1,
            -- –∏–ª–∏ any –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:
            sum(some_value) AS total_some_value
        FROM table_b_1
        GROUP BY key
    ),
    type_b_data_agg_2 AS (
        SELECT
            key,
            groupArray(value_2) AS aggregated_values_2
        FROM table_b_2
        GROUP BY key
    )
SELECT
    a.key,
    a.attr1,
    a.attr2,
    b1.aggregated_values_1,
    b1.total_some_value,
    b2.aggregated_values_2
FROM type_a_data a
LEFT JOIN type_b_data_agg_1 b1 ON a.key = b1.key
LEFT JOIN type_b_data_agg_2 b2 ON a.key = b2.key
```

## üöÄ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ "—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã ClickHouse"

–í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –≤–∞—à –ø–æ–¥—Ö–æ–¥ –µ—â–µ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º, –∏—Å–ø–æ–ª—å–∑—É—è —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏:

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **—Å–ª–æ–≤–∞—Ä–µ–π (Dictionaries)**

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∞ –ë ‚Äî —ç—Ç–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –≤–∏—Ç—Ä–∏–Ω–µ, —Å–æ–∑–¥–∞–π—Ç–µ `Dictionary`. ClickHouse –∑–∞–≥—Ä—É–∑–∏—Ç –∏—Ö –≤ –ø–∞–º—è—Ç—å, –∏ JOIN –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.

```sql
CREATE DICTIONARY dict_b_data (
    key UInt64,
    aggregated_values Array(String)
) PRIMARY KEY key
SOURCE(CLICKHOUSE(
    TABLE 'table_b'
    QUERY 'SELECT key, groupArray(value) FROM table_b GROUP BY key'
))
LIFETIME(MIN 300 MAX 360)
LAYOUT(HASHED());
```

–ò –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –∑–∞–ø—Ä–æ—Å–µ:
```sql
SELECT
    a.key,
    a.attr,
    dictGet('dict_b_data', 'aggregated_values', a.key) AS b_values
FROM table_a a
```

### 2. **–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Materialized Views)**

–ï—Å–ª–∏ –≤–∏—Ç—Ä–∏–Ω–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∏ –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ, —Å–æ–∑–¥–∞–π—Ç–µ MV –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞ –ë. –≠—Ç–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç —Ç—è–∂–µ–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è `GROUP BY` –≤ —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å.

```sql
CREATE MATERIALIZED VIEW mv_b_agg
ENGINE = ReplacingMergeTree
ORDER BY key
AS SELECT
    key,
    groupArrayState(value) AS agg_values_state
FROM table_b
GROUP BY key;
```

–ó–∞—Ç–µ–º –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
```sql
SELECT
    key,
    groupArrayMerge(agg_values_state) AS final_values
FROM mv_b_agg
GROUP BY key
```

### 3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `LIMIT BY` –≤–º–µ—Å—Ç–æ `GROUP BY` –¥–ª—è "–ø–æ—Å–ª–µ–¥–Ω–∏—Ö N" —Å–æ–±—ã—Ç–∏–π**

–ï—Å–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞ –∏–∑ —Ç–∏–ø–∞ –ë –≤–∞–º –Ω—É–∂–Ω—ã –Ω–µ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∞ —Ç–æ–ª—å–∫–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `LIMIT BY`. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª–µ–≥—á–µ, —á–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –º–∞—Å—Å–∏–≤.

```sql
SELECT
    key,
    groupArray(value) AS last_values
FROM (
    SELECT *
    FROM table_b
    ORDER BY event_date DESC
    LIMIT 5 BY key
)
GROUP BY key
```

### 4. **–§—É–Ω–∫—Ü–∏—è `arrayZip` –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤**

–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Ç–∏–ø–∞ –ë –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö —Å–≤—è–∑–Ω–æ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `arrayZip`, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –º–∞—Å—Å–∏–≤ –∫–æ—Ä—Ç–µ–∂–µ–π.

```sql
SELECT
    key,
    arrayZip(
        groupArray(attribute_1),
        groupArray(attribute_2),
        groupArray(timestamp)
    ) AS complex_attributes
FROM table_b
GROUP BY key
```

## üí° –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1.  **–í–∞—à –±–∞–∑–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –≤–µ—Ä–µ–Ω.** –ö–∞—Å–∫–∞–¥ CTE —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π -> `JOIN` –ø–æ —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –≤ ClickHouse.
2.  **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `LEFT JOIN`.** –î–∞–∂–µ –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã –≤ –Ω–∞–ª–∏—á–∏–∏ –≤—Å–µ—Ö –∫–ª—é—á–µ–π, `LEFT JOIN` –∏–Ω–æ–≥–¥–∞ –≤–µ–¥–µ—Ç —Å–µ–±—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–µ–µ –≤ ClickHouse –∏ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Ç–∏–ø–∞ –ê, –µ—Å–ª–∏ –ø–æ –Ω–∏–º –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞ –ë.
3.  **–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä–µ–π** –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏ –Ω–µ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤.
4.  **–î–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≤–∏—Ç—Ä–∏–Ω—ã** –∏–∑—É—á–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è **–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π** –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏.
5.  **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞** —Å –ø–æ–º–æ—â—å—é `EXPLAIN PIPELINE` –∏ `EXPLAIN SYNTAX`, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ ClickHouse –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ª–∏—à–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π.

–°—Ö–µ–º–∞ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è ClickHouse –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Äî –∞–≥—Ä–µ–≥–∞—Ü–∏—é –∏ —Ä–∞–±–æ—Ç—É —Å –º–∞—Å—Å–∏–≤–∞–º–∏, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è —Å–ª–∞–±—ã–µ ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü.
