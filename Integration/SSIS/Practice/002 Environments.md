**Параметры (Parameters) и Environments (Окружения) НЕ связаны автоматически.** Это **отдельные сущности**, которые нужно связать вручную. Именно в этом и есть гибкость.

---

### **Сценарий: Пакет для загрузки файлов**

У нас есть пакет `LoadSales.dtsx`. Ему нужно знать:
1.  **Папку**, откуда брать файлы (`SourceFolder`)
2.  **Имя файла** (`FileName`)

Мы создаем в пакете **Параметры (Parameters)** на уровне проекта или пакета.
![](https://i.imgur.com/1oW0fTk.png)

*(Это "дырки" в нашем пакете, которые нужно заполнить значениями)*

---

### **ШАГ 1: Развертывание (Deploy)**

Мы выгружаем проект (`.ispac`) в каталог `SSISDB`. Параметры `$Project::SourceFolder` и `$Package::FileName` **переезжают вместе с проектом** и видны в SSMS.

**На этом этапе у параметров есть значения по умолчанию**, которые вы задали при разработке (например, `C:\Temp\` и `test.csv`). **Но эти значения "зашиты" в проект.**

---

### **ШАГ 2: Создание Окружений (Environments) — "Наборы настроек"**

Мы создаем **несколько независимых наборов значений** для разных серверов.

В SSMS, внутри папки `SSISDB/YourFolder/`:
1.  ПКМ на `Environments` -> **Create Environment**.
2.  Создаем два:
    *   `ENV_DEV` (для разработки)
    *   `ENV_PROD` (для продакшена)

3.  Внутри каждого Environment создаем **Variables (Переменные Окружения)**.
    *   В `ENV_DEV`:  
        `var_SourceFolder` = `\\dev-server\share\`  
        `var_FileName` = `sales_dev.csv`
    *   В `ENV_PROD`:  
        `var_SourceFolder` = `\\prod-server\data\`  
        `var_FileName` = `sales.csv`

**Важное замечание:** Имена переменных в Environment (`var_SourceFolder`) **НЕ обязаны совпадать** с именами параметров проекта (`$Project::SourceFolder`). Связь устанавливается позже.

---

### **ШАГ 3: Связывание Проекта с Окружением (Reference)**

Теперь нужно сказать проекту: "Ты можешь использовать настройки из этого Environment".

1.  В SSMS, ПКМ на развернутом проекте -> **Configure**.
2.  Переходим на вкладку **References**. Нажимаем **Add...** и выбираем, например, `ENV_PROD`.
3.  Теперь проект "знает" о существовании `ENV_PROD` и может использовать его переменные.

---

### **ШАГ 4: Привязка (Mapping) Параметров к Переменным Окружения**

**Это самый главный шаг — "соединение проводов".**

1.  В том же окне **Configure** переходим на вкладку **Parameters** (или **Connection Managers** для строк подключения).
2.  Видим список всех параметров проекта и пакета.
3.  Для параметра `SourceFolder`:
    *   В колонке **Value Source** (Источник значения) выбираем **Environment Variable** (а не "Direct value" или "SQL query").
    *   В колонке **Environment Variable** появляется выпадающий список. Выбираем ту переменную из связанного Environment, которую хотим использовать — например, `var_SourceFolder`.
4.  Повторяем для `FileName` -> привязываем к `var_FileName`.

**Что произошло:** Мы сказали: "Дорогой пакет, когда тебе понадобится значение для параметра `SourceFolder`, бери его не из значения по умолчанию, а из переменной `var_SourceFolder`, которая лежит в Environment `ENV_PROD`".

---

### **ШАГ 5: Запуск с конкретным Окружением**

Теперь, когда мы запускаем пакет, **мы должны указать, какое Environment использовать**.

*   **В SSMS:** При запуске пакета вручную есть выпадающий список **Environment**. Выбираем `ENV_PROD`.
*   **В SQL Agent Job:** В шаге типа "SSIS Package" есть поле **Environment**. Выбираем `ENV_PROD`.
*   **Через dtexec:** Используется ключ `/envreference` или `/environment`.

**Результат:** При запуске с `ENV_PROD` движок SSIS:
1.  Видит, что проект ссылается на `ENV_PROD`.
2.  Берет из `ENV_PROD` значение переменной `var_SourceFolder` (`\\prod-server\data\`).
3.  Передает это значение в параметр `$Project::SourceFolder`.
4.  Пакет выполняется с продакшен-путями.

---

### **Создание другого варианта конфигурации (и привязка к пакету)**

Вот как это работает на практике:

1.  **У вас уже есть `ENV_DEV` и `ENV_PROD`** с разными значениями переменных.
2.  **Проект может иметь ссылки на НЕСКОЛЬКО Environments одновременно!** Вы можете добавить в References и `ENV_DEV`, и `ENV_PROD`.
3.  **НО при запуске вы выбираете ТОЛЬКО ОДИН активный Environment.**

**Как переключиться с PROD на DEV?**

*   **Для ручного запуска:** Просто выбираете другое окружение в выпадающем списке.
*   **Для задания SQL Agent:** Создаете **ДВА разных задания**:
    *   `Job_PROD_LoadSales` -> использует Environment = `ENV_PROD`, запускается ночью.
    *   `Job_DEV_TestLoad` -> использует Environment = `ENV_DEV`, запускается по требованию для тестирования.
*   **ИЛИ:** Меняете настройку Environment в существующем задании и перезапускаете его.

---

### **Визуальная аналогия**

Представьте, что **Пакет** — это **телевизор**, а **Параметры** — это **кнопки на пульте** (Громкость, Канал).

*   **Environment** — это **предустановки на пульте** ("Кино", "Новости", "Спорт").
*   **Переменные внутри Environment** — это **конкретные значения для каждой кнопки в этой предустановке** ("Кино": Громкость=30, Канал=5; "Спорт": Громкость=50, Канал=7).
*   **Mapping (привязка)** — это процесс, когда вы говорите пульту: "Когда я выбираю предустановку 'Кино', то кнопке 'Громкость' присвой значение 30".
*   **Запуск с Environment** — это **нажатие кнопки "Кино" на пульте**. Телевизор мгновенно получает все нужные настройки.

---

### **Практический итог и ответы на ваши вопросы:**

1.  **"Параметры автоматически прогружаются в Environments?"**  
    **НЕТ.** Environments создаются отдельно и независимо.

2.  **"А потом мы их можем назначить/поменять?"**  
    **ДА.** Вы назначаете (маппите) параметры к переменным окружения в окне Configure. Менять можно в любой момент — это метаданные в SSISDB, не требующие пересборки пакета.

3.  **"Как создать другие варианты конфигурации?"**  
    Создаете новый **Environment** (например, `ENV_TEST`), заполняете его своими переменными, добавляете ссылку на него в проект и делаете маппинг параметров на эти новые переменные.

4.  **"Как привязать другой вариант к пакету?"**  
    **На уровне проекта:** Добавляете нужный Environment в References проекта и делаете маппинг.  
    **На уровне запуска:** При запуске (в SSMS, Agent, dtexec) просто **выбираете другое Environment из списка**. Все маппинги уже настроены, значения подставятся автоматически.

**Главная мысль:** **Parameters и Environments — это система "ключ-значение" с косвенной адресацией.** Parameters — это "ключи", которые ищут свои "значения" в выбранном Environment через настроенное соответствие (mapping). Это дает огромную гибкость управления конфигурациями без изменения кода пакетов.
