## **📊 ВИЗУАЛИЗАЦИЯ: Initial Load + CDC Process**

```
ВРЕМЯ      CONTROL FLOW                DATA FLOW                      CDC LSN TRACK
---------- --------------------------  -----------------------------  -----------------------------------
T0 09:59                                                              LSN_X (старые данные, не важны)
          │
          ▼
T1 10:00  [CDC Control Task]           НЕТ ОБРАБОТКИ                   ════════════════════════
          Operation:                    (только управление            LSN_A ← ЗАПОМНИЛИ ЭТУ МЕТКУ!
          "Mark initial load start"     метаданными)                  (начало initial load)
          │                            │                             │
          ▼                            ▼                             ▼
T1 10:01  [Data Flow Task]             ╔═══════════════════════════╗  Изменения в источнике
          "Initial Load"               ║ OLE DB Source →           ║  Пользователь меняет
          (запуск копирования)         ║   SELECT * FROM Sales     ║  строку ID=100
          │                            ║ OLE DB Destination →      ║  │
          │                            ║   INSERT INTO DWH.Sales   ║  ▼ LSN_B (B > A)
          │                            ╚═══════════════════════════╝  Изменение записывается в cdc.Sales_CT
          │                            Копирование 1 млн строк...     │
          │                            │                             │
T2 11:30  │                            ╔═══════════════════════════╗  Пользователь удаляет
          │                            ║ Копирование продолжается  ║  строку ID=200
          │                            ║ Обработано: 500K строк    ║  │
          │                            ╚═══════════════════════════╝  ▼ LSN_C (C > B)
          │                            │                             Удаление в cdc.Sales_CT
          │                            │                             │
          │                            │                             │
T3 12:00  │                            ╔═══════════════════════════╗  Новые INSERT'ы
          │                            ║ Копирование завершено!    ║  │
          │                            ║ Всего: 1M строк           ║  ▼ LSN_D, LSN_E, ...
          │                            ╚═══════════════════════════╝  │
          ▼                                                           │
                                                                      │
╔═══════════════════════════════════════════════════════════════════════════════════╗
║                        ПАУЗА: Initial Load завершен                              ║
║   В DWH: данные на ~T1 (10:00), но без изменений LSN_B, LSN_C, LSN_D, LSN_E      ║
╚═══════════════════════════════════════════════════════════════════════════════════╝
                                                                      │
T3 12:01  [CDC Control Task]           НЕТ ОБРАБОТКИ                   │
          Operation:                    (получение диапазона)          │
          "Get processing range"        │                             ТЕКУЩИЙ МАКСИМУМ: LSN_F
          │                            │                             (все изменения до этого момента)
          ▼                            ▼                             │
T3 12:01  [Data Flow Task]             ╔═══════════════════════════╗  │
          "CDC Processing"             ║ CDC Source →              ║  │
          │                            ║   Диапазон: A → F         ║  │
          │                            ║ CDC Splitter →            ║  ├── CDC Source читает
          │                            ║   Обработка INSERT/       ║  │   изменения A→F
          │                            ║   UPDATE/DELETE           ║  │   (B, C, D, E, F)
          │                            ╚═══════════════════════════╝  │
          │                            │                             │
          ▼                            ▼                             ▼
T3 12:03  [CDC Control Task]           НЕТ ОБРАБОТКИ                   ════════════════════════
          Operation:                                                    LSN_F ← НОВАЯ МЕТКА!
          "Mark processed range"                                        (конец processed range)
          │
          ▼
T3 12:03  [ПАКЕТ ЗАВЕРШЕН]
          DWH теперь синхронизирован
          с источником на момент T3!
```

---

## **📊 ВИЗУАЛИЗАЦИЯ: Последующие Incremental Loads**

```
ДЕНЬ 2, 03:00 - Ежедневная инкрементальная загрузка
ВРЕМЯ      CONTROL FLOW                DATA FLOW                      CDC LSN TRACK
---------- --------------------------  -----------------------------  -----------------------------------
          [Запуск по расписанию]                                      ПРОШЛАЯ НОЧЬ:
          │                                                           новые изменения
          ▼                                                           │
T4 03:00  [CDC Control Task]           НЕТ ОБРАБОТКИ                   ├── LSN_G, LSN_H, LSN_I, ...
          "Get processing range"        │                             │
          │                            │                             ТЕКУЩИЙ МАКСИМУМ: LSN_J
          ▼                            ▼                             │
T4 03:00  [Data Flow Task]             ╔═══════════════════════════╗  │
          "CDC Processing"             ║ CDC Source →              ║  │
          │                            ║   Диапазон: F → J         ║  ├── Читаем только НОВЫЕ
          │                            ║   (только изменения       ║  │   изменения (F→J)
          │                            ║    после последней        ║  │   не перечитываем A→F
          │                            ║    загрузки)              ║  │
          │                            ╚═══════════════════════════╝  │
          ▼                            ▼                             ▼
T4 03:02  [CDC Control Task]                                         ════════════════════════
          "Mark processed range"                                      LSN_J ← ОБНОВЛЯЕМ МЕТКУ!
```

---

## **📊 ВИЗУАЛИЗАЦИЯ: Сбой и восстановление**

```
ДЕНЬ 3 - СБОЙ ПРИ ЗАГРУЗКЕ
ВРЕМЯ      CONTROL FLOW                DATA FLOW                      CDC LSN TRACK
---------- --------------------------  -----------------------------  -----------------------------------
T5 03:00  [CDC Control Task]           НЕТ ОБРАБОТКИ                   ТЕКУЩАЯ МЕТКА: LSN_J
          "Get processing range"        │                             Изменения за день:
          │                            │                             LSN_K, LSN_L, LSN_M
          ▼                            ▼                             ТЕКУЩИЙ МАКСИМУМ: LSN_N
T5 03:00  [Data Flow Task]             ╔═══════════════════════════╗
          "CDC Processing"             ║ CDC Source →              ║
          │                            ║   Диапазон: J → N         ║  Чтение J→N начинается
          │                            ║   Обработано: LSN_K ✓     ║  │
          │                            ║               LSN_L ✓     ║  │
          │                            ╚═══════════════════════════╝  │
          │                            │                             │
T5 03:01  │                            💥💥💥 СБОЙ! 💥💥💥           ├── Обработаны: K, L
          │                            Сеть отвалилась               │   НЕ обработаны: M, N
          ▼                            Data Flow упал                │
                                                                     ▼
╔═══════════════════════════════════════════════════════════════════════════════════╗
║                    МЕТКА НЕ ОБНОВЛЕНА! Осталась = LSN_J                          ║
║   В DWH: изменения LSN_K, LSN_L применены, но LSN_M, LSN_N - НЕТ                 ║
╚═══════════════════════════════════════════════════════════════════════════════════╝
                                                                     │
T5 08:00  [АДМИНИСТРАТОР ПЕРЕЗАПУСКАЕТ ПАКЕТ]                       │
          │                                                         │
          ▼                                                         │
T5 08:00  [CDC Control Task]           НЕТ ОБРАБОТКИ                 │
          "Get processing range"        │                           ТЕКУЩИЙ МАКСИМУМ: LSN_P
          │                            │                           (за ночь были новые изменения)
          ▼                            ▼                           │
T5 08:00  [Data Flow Task]             ╔═══════════════════════════╗│
          "CDC Processing"             ║ CDC Source →              ║│
          │                            ║   Диапазон: J → P         ║├── ❗ПЕРЕЧИТЫВАЕТ J→P
          │                            ║   (ВСЕ с момента          ║│   (K, L, M, N, O, P)
          │                            ║    последней метки)       ║│   ДУБЛИРОВАНИЕ K, L!
          │                            ╚═══════════════════════════╝│
          ▼                            ▼                           ▼
T5 08:02  [CDC Control Task]                                         ════════════════════════
          "Mark processed range"                                      LSN_P ← ТЕПЕРЬ ОБНОВЛЕНО
```

---

## **🎯 КЛЮЧЕВЫЕ ВЫВОДЫ из визуализации:**

### **1. LSN — это "водяные знаки" во времени:**
```
Initial Load Start:   LSN_A
Изменение 1:          LSN_B
Изменение 2:          LSN_C
...
Current Max:          LSN_F, затем LSN_J, затем LSN_N
```

### **2. Initial Load ≠ CDC Load:**
- **Initial Load:** Копирует снимок данных на момент **~LSN_A**
- **CDC Load:** Применяет изменения **LSN_A → LSN_F** к этому снимку

### **3. Метка (CDC State) — это "что уже загрузили":**
- После Initial Load: `State = LSN_A` ("загрузили данные до A")
- После первого CDC: `State = LSN_F` ("загрузили все до F")
- После сбоя: `State = LSN_J` ("загрузили только до J, хотя могли быть K,L")

### **4. CDC Source всегда читает ОТ State ДО CurrentMax:**
```
Формула: ProcessRange = (StoredState → CurrentMaxLSN)
Пример: J → P (даже если часть уже обработана)
```

### **5. Проблема идемпотентности:**
При сбое и перезапуске CDC Source **перечитывает уже частично обработанный диапазон** → нужна логика для обработки дублей.

---

## **📈 ГРАФИК ЗАВИСИМОСТИ LSN ОТ ВРЕМЕНИ:**

```
LSN       │                                                                   ▲
Значение  │                                                                   │
          │                   Инкрементальные загрузки                        │
          │               (маленькие шаги, только новые изменения)            │
          │                                                                   │
    LSN_P ├───────────────────────────────────────────────────● ← Day 3 Max  │
          │                                                   │               │
    LSN_N ├───────────────────────────────────●               │               │
          │                                   │               │               │
    LSN_J ├───────────────●                   │               │               │
          │               │                   │               │               │
    LSN_F ├───●           │                   │               │               │
          │   │           │                   │               │               │
    LSN_A ├●──┼───────────┼───────────────────┼───────────────┼───────────────┤ Время
          │   │           │                   │               │               │
          │ Initial Load  │ Day 2             │ Day 3         │ Day 3         │
          │   Start       │ Incremental       │ Incremental   │ Restart       │
          │               │ (J→F)             │ (J→N) FAILED! │ (J→P)         │
          │               │                   │               │               │
          │   Initial     │ CDC Range         │ CDC Range     │ CDC Range     │
          │   CDC Range   │ Processed ✓       │ Partial       │ Full (with    │
          │   (A→F)       │ State = J         │ State = J     │ duplicates)   │
          │               │                   │               │ State = P     │
          └───────────────┴───────────────────┴───────────────┴───────────────┘
           T1 10:00      T4 03:00          T5 03:00         T5 08:00
```

---

## **🔧 Практический workflow для разработчика:**

1. **Initial Load Package:**
   ```
   CDC Control: Mark start → Запоминаем LSN_A
   Data Flow: Full table copy → Данные на момент ~LSN_A
   ```

2. **First CDC Run (immediately after):**
   ```
   CDC Control: Get range → LSN_A → CurrentMax
   Data Flow: Process changes → Применяем LSN_A→LSN_F
   CDC Control: Mark processed → Сохраняем LSN_F
   ```

3. **Regular Incremental (daily):**
   ```
   CDC Control: Get range → LSN_F → CurrentMax
   Data Flow: Process changes → Только новые изменения
   CDC Control: Mark processed → Обновляем метку
   ```

4. **After Failure:**
   ```
   CDC Control: Get range → Старая метка → CurrentMax
   Data Flow: Process changes → ❗Весь диапазон, включая дубли
   CDC Control: Mark processed → Новая метка
   ```

Эта визуализация показывает, почему **CDC State так критически важна** — это единственная точка отсчета, которая говорит "что мы уже загрузили". Все, что лежит после этой точки в логе CDC, еще предстоит обработать.
